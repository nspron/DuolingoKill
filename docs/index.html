<!DOCTYPE html>
<html>
<head>
    <title>Daily Open Statistics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container {
            width: 80%;
            margin: 20px auto;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        table {
            width: 80%;
            margin: 20px auto;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>Daily Open Statistics</h1>
    
    <div class="chart-container">
        <h2>Total Opens Per Day</h2>
        <canvas id="totalOpensChart" height="200"></canvas>
    </div>
    
    <div class="chart-container">
        <h2>Unique Devices Per Day</h2>
        <canvas id="uniqueDevicesChart" height="200"></canvas>
    </div>
    
    <div class="chart-container">
        <h2>Average Opens Per Device</h2>
        <canvas id="avgOpensChart" height="200"></canvas>
    </div>
    
    <table id="statsTable">
        <thead>
            <tr>
                <th>Date</th>
                <th>Device ID</th>
                <th>Open Count</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    
    <script>
        fetch('https://raw.githubusercontent.com/nspron/DuolingoKill/main/stats/daily_opens.csv')
            .then(response => response.text())
            .then(data => {
                const rows = data.split('\n').filter(row => row.trim() !== '');
                const headers = rows.shift().split(',');
                
                // 准备数据
                const stats = rows.map(row => {
                    const values = row.split(',');
                    const entry = {};
                    headers.forEach((header, i) => {
                        entry[header] = values[i];
                    });
                    return entry;
                }).filter(entry => entry.date && entry.device_id && entry.open_count);
                
                // 按日期聚合数据
                const dailyStats = {};
                
                stats.forEach(stat => {
                    if (!dailyStats[stat.date]) {
                        dailyStats[stat.date] = {
                            totalOpens: 0,
                            devices: new Set(),
                            deviceCounts: []
                        };
                    }
                    
                    const count = parseInt(stat.open_count) || 0;
                    dailyStats[stat.date].totalOpens += count;
                    dailyStats[stat.date].devices.add(stat.device_id);
                    dailyStats[stat.date].deviceCounts.push(count);
                });
                
                const dates = Object.keys(dailyStats).sort();
                
                // 准备图表数据
                const totalOpensData = dates.map(date => dailyStats[date].totalOpens);
                const uniqueDevicesData = dates.map(date => dailyStats[date].devices.size);
                const avgOpensData = dates.map(date => 
                    (dailyStats[date].totalOpens / dailyStats[date].devices.size).toFixed(1)
                );
                
                // 绘制图表
                renderChart('totalOpensChart', 'bar', dates, totalOpensData, 'Total Opens', 'rgb(54, 162, 235)');
                renderChart('uniqueDevicesChart', 'line', dates, uniqueDevicesData, 'Unique Devices', 'rgb(75, 192, 192)');
                renderChart('avgOpensChart', 'bar', dates, avgOpensData, 'Average Opens', 'rgb(255, 159, 64)');
                
                // 填充表格
                const tbody = document.querySelector('#statsTable tbody');
                stats.forEach(stat => {
                    const tr = document.createElement('tr');
                    headers.forEach(header => {
                        const td = document.createElement('td');
                        td.textContent = stat[header] || '-';
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
            })
            .catch(error => {
                console.error('Error loading stats:', error);
                document.body.innerHTML += '<p>Error loading data. Please try again later.</p>';
            });
            
        function renderChart(canvasId, type, labels, data, label, color) {
            new Chart(
                document.getElementById(canvasId),
                {
                    type: type,
                    data: {
                        labels: labels,
                        datasets: [{
                            label: label,
                            data: data,
                            backgroundColor: type === 'bar' ? color : undefined,
                            borderColor: color,
                            borderWidth: 2,
                            tension: type === 'line' ? 0.1 : undefined,
                            fill: type === 'line'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                precision: 0
                            }
                        }
                    }
                }
            );
        }
    </script>
</body>
</html>
