<!DOCTYPE html>
<html>
<head>
    <title>Enhanced Usage Stats</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container {
            width: 80%;
            margin: 20px auto;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        table {
            width: 80%;
            margin: 20px auto;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>Enhanced Usage Statistics</h1>
    
    <div class="chart-container">
        <h2>Daily Usage Duration (Minutes)</h2>
        <canvas id="durationChart" height="200"></canvas>
    </div>
    
    <div class="chart-container">
        <h2>Daily Opens</h2>
        <canvas id="opensChart" height="200"></canvas>
    </div>
    
    <div class="chart-container">
        <h2>Unique Devices</h2>
        <canvas id="devicesChart" height="200"></canvas>
    </div>
    
    <table id="statsTable">
        <thead>
            <tr>
                <th>Date</th>
                <th>Device ID</th>
                <th>IP</th>
                <th>Duration (min)</th>
                <th>Daily Opens</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    
    <script>
        fetch('https://raw.githubusercontent.com/你的用户名/你的仓库名/main/stats/enhanced_stats.csv')
            .then(response => response.text())
            .then(data => {
                const rows = data.split('\n').filter(row => row.trim() !== '');
                const headers = rows.shift().split(',');
                
                // 准备数据
                const stats = rows.map(row => {
                    const values = row.split(',');
                    const entry = {};
                    headers.forEach((header, i) => {
                        entry[header] = values[i];
                    });
                    return entry;
                });
                
                // 按日期聚合
                const dailyStats = {};
                const uniqueDevices = new Set();
                
                stats.forEach(stat => {
                    if (!dailyStats[stat.date]) {
                        dailyStats[stat.date] = {
                            duration: 0,
                            opens: 0,
                            devices: new Set()
                        };
                    }
                    
                    dailyStats[stat.date].duration += parseFloat(stat.duration_minutes) || 0;
                    dailyStats[stat.date].opens += parseInt(stat.daily_opens) || 0;
                    dailyStats[stat.date].devices.add(stat.device_id);
                    uniqueDevices.add(stat.device_id);
                });
                
                const dates = Object.keys(dailyStats).sort();
                
                // 绘制图表
                renderChart('durationChart', 'bar', dates, 
                    dates.map(date => dailyStats[date].duration.toFixed(1)), 
                    'Usage Duration (min)');
                
                renderChart('opensChart', 'line', dates,
                    dates.map(date => dailyStats[date].opens),
                    'Daily Opens');
                
                renderChart('devicesChart', 'bar', dates,
                    dates.map(date => dailyStats[date].devices.size),
                    'Unique Devices');
                
                // 填充表格
                const tbody = document.querySelector('#statsTable tbody');
                stats.forEach(stat => {
                    const tr = document.createElement('tr');
                    headers.forEach(header => {
                        const td = document.createElement('td');
                        td.textContent = stat[header] || '-';
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
            })
            .catch(error => {
                console.error('Error loading stats:', error);
                document.body.innerHTML += '<p>Error loading data. Please try again later.</p>';
            });
            
        function renderChart(canvasId, type, labels, data, label) {
            new Chart(
                document.getElementById(canvasId),
                {
                    type: type,
                    data: {
                        labels: labels,
                        datasets: [{
                            label: label,
                            data: data,
                            backgroundColor: type === 'bar' ? 'rgba(54, 162, 235, 0.7)' : 'rgba(75, 192, 192, 0.7)',
                            borderColor: type === 'bar' ? 'rgb(54, 162, 235)' : 'rgb(75, 192, 192)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                }
            );
        }
    </script>
</body>
</html>
